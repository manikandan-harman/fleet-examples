
kubectl create secret generic azure-secret --from-literal azurestorageaccountname=industqa2308231027262sa --from-literal azurestorageaccountkey="mopnVWSD1tCVDelGQQNel7R1Ujs/fcwj7xWYSjxXhu28kWOvlxrPco5cQR+QpX8wgEwX6M3nDS2B+ASt9i1ehA==" --type=Opaque -n 

# rpm -Uvh https://packages.microsoft.com/config/rhel/8/packages-microsoft-prod.rpm
#yum install blobfuse2


wget https://github.com/Azure/azure-storage-fuse/releases/download/blobfuse2-2.0.0-preview.3/blobfuse2-2.0.0-preview.3-Ubuntu-22.04-x86-64.deb
sudo apt-get install libfuse3-dev fuse3 -y
sudo dpkg -i blobfuse2-2.0.0-preview.3-Ubuntu-22.04-x86-64.deb



helm repo add blob-csi-driver https://raw.githubusercontent.com/kubernetes-sigs/blob-csi-driver/master/charts

helm install blob-csi-driver blob-csi-driver/blob-csi-driver --set node.enableBlobfuseProxy=true --namespace kube-system --set controller.replicas=1


 kubectl exec -it  ekuiper-v2-57fc9c69dd-bs2nz    -c ekuiper -n coreandcommon -- touch /shared_path/123.txt

sudo chmod 644 /etc/rancher/k3s/k3s.yaml

--------------storageClass---------------------
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: blob-dv-fuse-v2
provisioner: blob.csi.azure.com
parameters:
  resourceGroup: pep-edap-eiotp-data-qa-eus-01-rg
  storageAccount: industqa2308231027262sa
  containerName: industrialqa
reclaimPolicy: Retain  # if set as "Delete" container would be removed after pvc deletion
volumeBindingMode: Immediate
allowVolumeExpansion: true
mountOptions:
  - -o allow_other
  - --file-cache-timeout-in-seconds=120
  - --use-attr-cache=true
  - --cancel-list-on-mount-seconds=60  # prevent billing charges on mounting
  - -o attr_timeout=120
  - -o entry_timeout=120
  - -o negative_timeout=120
  - --cache-size-mb=1000
  ----------------persistentVolume-------------
  apiVersion: v1
kind: PersistentVolume
metadata:
  annotations:
    pv.kubernetes.io/provisioned-by: blob.csi.azure.com
  name: pv-blob-v2
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: blob-fuse-v2
  mountOptions:
    - -o allow_other
    - --file-cache-timeout-in-seconds=120
  csi:
    driver: blob.csi.azure.com
    readOnly: false
    # make sure volumeid is unique for every storage blob container in the cluster
    # the # character is reserved for internal use
    volumeHandle: industdv2308160642424sa_images
    volumeAttributes:
      resourceGroup: pep-edap-eiotp-data-qa-eus-01-rg
      storageAccount: industqa2308231027262sa
      containerName: industrialqa
      protocol: fuse2
  # secrete for storage account 
    nodeStageSecretRef:
      name: azure-secret
      namespace: industrialqa-ns
      -------------PVC-------------------
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-blob-v2
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  volumeName: pv-blob-v2
  storageClassName: blob-fuse-v2

  ---------------PVC2---------------

  apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ekuiper-pvc
  namespace: industrialqa-ns
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: local-path

  -----------------ekuiper-v3----------------

  apiVersion: apps/v1
kind: Deployment
metadata:
  name: ekuiper-v3
  namespace: industrialqa-ns
spec:
  selector:
    matchLabels:
      app: ekuiper-v3
  replicas: 1
  template:
    metadata:
      labels:
        app: ekuiper-v3
    spec:
     securityContext:
          fsGroup: 1001
          runAsUser: 1001
          runAsGroup: 1001
     containers:
      - name: ekuiper-v3
        image: lfedge/ekuiper:1.9
        imagePullPolicy: IfNotPresent
        volumeMounts:
         - name: ekuiper-volv
           mountPath: "/kuiper/data"
         - name: shared-volume
           mountPath: "/shared_path"
        securityContext:
          runAsUser: 0
          allowPrivilegeEscalation: false
        env:
        - name: MQTT_SOURCE__DEFAULT__SERVER
          value: 'tcp://emqxbrokersvc.coreandcommon.svc.cluster.local:1883'
        - name: KUIPER__BASIC__IGNORECASE
          value: 'false'
        ports:
         - containerPort: 9081
           name: management
           protocol: TCP
       
      - name: watcher-container
        image: priyankajagtap007/blobfuse:8.3
        volumeMounts:
        - name: shared-volume
          mountPath: "/shared_path"
        - name: blobfuse-destination
          mountPath: "/kuiper/rtsp"
        env:
        - name: SOURCE_PATH
          value: "/shared_path"
        - name: DESTINATION_PATH
          value: "/kuiper/rtsp"
          
     volumes:
      - name: ekuiper-volv
        persistentVolumeClaim:
          claimName: data-pvc
      - name: shared-volume
        persistentVolumeClaim:
          claimName: ekuiper-pvc
      - name: blobfuse-destination
        persistentVolumeClaim:
          claimName: pvc-blob-v2
---
apiVersion: v1
kind: Service
metadata:
  name: ekuipersvc-v3
  namespace: industrialqa-ns
spec:
  type: ClusterIP
  selector:
    app: ekuiper
  ports:
    - name: management
      port: 9081
      targetPort: 9081
      protocol: TCP

      -----------------ekuiper-------------------
      apiVersion: apps/v1
kind: Deployment
metadata:
  name: ekuiper-v2
  namespace: industrialqa-ns
spec:
  selector:
    matchLabels:
      app: ekuiper-v2
  replicas: 1
  template:
    metadata:
      labels:
        app: ekuiper-v2
    spec:
     containers:
      - name: ekuiper-v2
        image: lfedge/ekuiper:1.9
        imagePullPolicy: IfNotPresent
        volumeMounts:
         - name: ekuiper-vol
           mountPath: "/kuiper/data"
         - name: blobfuse-vol
           mountPath: "/kuiper/rtsp"
        env:
        - name: MQTT_SOURCE__DEFAULT__SERVER
          value: 'tcp://nanomqbrokersvc.latam-vcr-ns.svc.cluster.local:1883'
        - name: KUIPER__BASIC__IGNORECASE
          value: 'false'
        ports:
         - containerPort: 9081
           name: management
           protocol: TCP
     securityContext:
        fsGroup: 1001
        runAsGroup: 1001
        runAsUser: 1001
     volumes:
      - name: ekuiper-vol
        persistentVolumeClaim:
          claimName: ekuiper-pvc
      - name: blobfuse-vol
        persistentVolumeClaim:
          claimName: pvc-blob-v2		   
---
apiVersion: v1
kind: Service
metadata:
  name: ekuipersvc-v2
  namespace: industrialqa-ns
spec:
  type: ClusterIP
  selector:
    app: ekuiper-v2
  ports:
    - name: management
      port: 9081
      targetPort: 9081
      protocol: TCP
